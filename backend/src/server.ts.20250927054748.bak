// backend/src/server.ts
import express from 'express';
import cors from 'cors';
// import helmet from 'helmet'; // Ø§Ú¯Ø± Ø®ÙˆØ§Ø³ØªÛŒ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØŒ ÙØ¹Ø§Ù„Ø´ Ú©Ù†
import compression from 'compression';
import cookieParser from 'cookie-parser';
import rateLimit from 'express-rate-limit';
import cron from 'node-cron';
import swaggerUi from 'swagger-ui-express';
import swaggerJsdoc from 'swagger-jsdoc';
import 'express-async-errors';

import { config } from '@/config/environment';
import { logger } from '@/utils/logger';
import { errorHandler } from '@/middleware/errorHandler';
import { requestLogger } from '@/middleware/requestLogger';
import { securityHeaders } from '@/middleware/securityHeaders';
import { prisma } from '@/config/database';

// --- BigInt -> string Ø¨Ø±Ø§ÛŒ Ø®Ø±ÙˆØ¬ÛŒ JSON (Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² 500: Do not know how to serialize a BigInt)
(BigInt.prototype as any).toJSON = function () {
  return this.toString();
};

const app = express();

// Ø§Ú¯Ø± Ø¨Ø®ÙˆØ§Ù‡ÛŒ JSON Ø®Ø±ÙˆØ¬ÛŒ Ø­ØªÛŒ Ø¯Ø± Ø¢Ø¨Ø¬Ú©Øªâ€ŒÙ‡Ø§ÛŒ ØªÙˆØ¯Ø±ØªÙˆ Ù‡Ù… BigInt Ø±Ø§ ØªØ¨Ø¯ÛŒÙ„ Ú©Ù†Ø¯
app.set('json replacer', (_key, value) => (typeof value === 'bigint' ? value.toString() : value));

// Trust proxy Ø¨Ø±Ø§ÛŒ Ø±ÙÛŒØªâ€ŒÙ„ÛŒÙ…ÛŒØª Ù¾Ø´Øª Ø±ÙÙˆØ±Ø³â€ŒÙ¾Ø±ÙˆÚ©Ø³ÛŒ
app.set('trust proxy', 1);

// Ù‡Ø¯Ø±Ù‡Ø§ÛŒ Ø§Ù…Ù†ÛŒØªÛŒ Ø³ÙØ§Ø±Ø´ÛŒ
app.use(securityHeaders);

// (Ø§Ø®ØªÛŒØ§Ø±ÛŒ) Ø§Ú¯Ø± Ø®ÙˆØ§Ø³ØªÛŒ helmet Ø®Ø§Ù… Ø§Ø¶Ø§ÙÙ‡ Ø´ÙˆØ¯:
// app.use(helmet());

// CORS
app.use(
  cors({
    origin: config.cors.origins,
    credentials: true,
    methods: ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'],
    allowedHeaders: ['Content-Type', 'Authorization', 'X-CSRF-Token'],
  })
);

// Rate limiting
const limiter = rateLimit({
  windowMs: config.rateLimit.windowMs,
  max: config.rateLimit.maxRequests,
  message: {
    error: 'Too many requests from this IP, please try again later.',
    retryAfter: Math.ceil(config.rateLimit.windowMs / 1000),
  },
  standardHeaders: true,
  legacyHeaders: false,
});
app.use(limiter);


// Body parsers
app.use(express.json({
  limit: '10mb',
  verify: (req, _res, buf) => {
    (req as any).rawBody = buf;
  },
}));
app.use(express.urlencoded({ extended: true, limit: '10mb' }));
app.use(cookieParser(config.security.cookieSecret));

// ÙØ´Ø±Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ
app.use(compression());

// Ù„Ø§Ú¯Ø± Ø±ÛŒÚ©ÙˆØ¦Ø³Øªâ€ŒÙ‡Ø§
app.use(requestLogger);

// Swagger
const swaggerOptions = {
  definition: {
    openapi: '3.0.0',
    info: {
      title: 'PSYGStore API',
      version: '1.0.0',
      description: 'API documentation for PSYGStore backend',
    },
    servers: [
      { url: config.app.baseUrl, description: 'App base URL' },
      { url: 'http://127.0.0.1:3000', description: 'Local dev' },
    ],
    components: {
      securitySchemes: {
        bearerAuth: { type: 'http', scheme: 'bearer', bearerFormat: 'JWT' },
      },
      // âœ… Ø§Ø³Ú©ÛŒÙ…Ø§Ù‡Ø§ Ùˆ Ø±ÛŒØ³Ù¾Ø§Ù†Ø³â€ŒÙ‡Ø§ÛŒ Ø§Ø² Ù¾ÛŒØ´â€ŒØªØ¹Ø±ÛŒÙâ€ŒØ´Ø¯Ù‡
      schemas: {
        ErrorResponse: {
          type: 'object',
          properties: {
            error: { type: 'string', example: 'Internal server error' },
            statusCode: { type: 'integer', example: 500 },
            timestamp: { type: 'string', format: 'date-time' },
          },
        },
        User: {
          type: 'object',
          properties: {
            id: { type: 'string', example: 'clxxx123' },
            email: { type: 'string', format: 'email' },
            fullName: { type: 'string' },
            walletBalanceRial: { type: 'string', description: 'BigInt as string' },
            walletBalanceCrypto: { type: 'string', description: 'Decimal as string' },
            authType: { type: 'string', enum: ['EMAIL', 'GOOGLE', 'WALLET'] },
            isAdmin: { type: 'boolean' },
            isActive: { type: 'boolean', example: true },
            createdAt: { type: 'string', format: 'date-time' },
            updatedAt: { type: 'string', format: 'date-time' },
          },
          required: ['id', 'email', 'fullName', 'authType', 'isAdmin', 'isActive', 'createdAt'],
        },
        LoginResponse: {
          type: 'object',
          properties: {
            success: { type: 'boolean', example: true },
            message: { type: 'string', example: 'Login successful' },
            user: { $ref: '#/components/schemas/User' },
            accessToken: { type: 'string' },
          },
        },
        RegisterResponse: {
          type: 'object',
          properties: {
            success: { type: 'boolean', example: true },
            message: { type: 'string', example: 'User registered successfully' },
            user: { $ref: '#/components/schemas/User' },
            accessToken: { type: 'string' },
          },
        },
      },
      responses: {
        UnauthorizedError: {
          description: 'Unauthorized',
          content: {
            'application/json': { schema: { $ref: '#/components/schemas/ErrorResponse' } },
          },
        },
        ValidationError: {
          description: 'Validation error',
          content: {
            'application/json': { schema: { $ref: '#/components/schemas/ErrorResponse' } },
          },
        },
        RateLimitError: {
          description: 'Too many requests',
          headers: { 'Retry-After': { schema: { type: 'integer', example: 60 } } },
          content: {
            'application/json': { schema: { $ref: '#/components/schemas/ErrorResponse' } },
          },
        },
      },
    },
  },
  // Ù…Ø³ÛŒØ±Ù‡Ø§ Ø±Ø§ Ø¨Ø§Ø²ØªØ± Ú¯Ø°Ø§Ø´ØªÙ… ØªØ§ Ù¾ÙˆØ´Ù‡â€ŒÙ‡Ø§ÛŒ ØªÙˆ Ø¯Ø± ØªÙˆ Ù‡Ù… Ø§Ø³Ú©Ù† Ø´ÙˆØ¯
  apis: ['./src/routes/**/*.ts', './src/controllers/**/*.ts'],
};
const specs = swaggerJsdoc(swaggerOptions);
app.use('/api-docs', swaggerUi.serve, swaggerUi.setup(specs));

// Health check (Ø±ÙˆÛŒ Ù‡Ø± Ø¯Ùˆ Ù…Ø³ÛŒØ± Ø¨Ø±Ø§ÛŒ Ø±Ø§Ø­ØªÛŒ ØªÙˆØ³Ø¹Ù‡)
app.get(['/health', '/api/health', '/healthz'], async (_req, res) => {
  try {
    await prisma.$queryRaw`SELECT 1`;
    res.json({
      status: 'healthy',
      timestamp: new Date().toISOString(),
      uptime: process.uptime(),
      environment: config.app.env,
      version: process.env.npm_package_version || '1.0.0',
      database: 'connected',
      // Ø§Ú¯Ø± Ø³Ø±ÙˆÛŒØ³ Ù‡Ù†ÙˆØ² Ø§Ø³ØªØ§Ø±Øª Ù†Ø´Ø¯Ù‡ Ø¨ÙˆØ¯ØŒ Ù‡Ù†Ø¯Ù„ Ø§Ù…Ù†:
      priceService: (priceUpdateService as any)?.getStatus?.() ?? 'unknown',
    });
  } catch (error) {
    logger.error('Health check failed:', error);
    res.status(503).json({
      status: 'unhealthy',
      timestamp: new Date().toISOString(),
      error: 'Database connection failed',
    });
  }
});

// Routes
import authRoutes from '@/routes/auth';
import userRoutes from '@/routes/users';
import orderRoutes from '@/routes/orders';
import articleRoutes from '@/routes/articles';
import paymentRoutes from '@/routes/payments';
import walletRoutes from '@/routes/wallet';
import couponRoutes from '@/routes/coupons';
import priceRoutes from '@/routes/prices';
import subscriptionRoutes from '@/routes/subscriptions';
import adminRoutes from '@/routes/admin';

app.use('/api/auth', authRoutes);
app.use('/api/users', userRoutes);
app.use('/api/orders', orderRoutes);
app.use('/api/articles', articleRoutes);
app.use('/api/payments', paymentRoutes);
app.use('/api/wallet', walletRoutes);
app.use('/api/coupons', couponRoutes);
app.use('/api/prices', priceRoutes);
app.use('/api/subscriptions', subscriptionRoutes);
app.use('/api/admin', adminRoutes);

// 404
app.use('*', (req, res) => {
  res.status(404).json({
    error: 'Endpoint not found',
    path: req.originalUrl,
    method: req.method,
  });
});

// Errors
app.use(errorHandler);

// Services
import { PriceUpdateService } from '@/services/PriceUpdateService';
import { PriceCronService } from '@/services/PriceCronService';

const priceUpdateService = new PriceUpdateService();
const priceCronService = new PriceCronService();

// Graceful shutdown
async function shutdown(signal: 'SIGTERM' | 'SIGINT') {
  logger.info(`${signal} received, shutting down gracefully`);
  try {
    priceUpdateService.stop();
    priceCronService.stop();
    await prisma.$disconnect();
  } finally {
    process.exit(0);
  }
}
process.on('SIGTERM', () => void shutdown('SIGTERM'));
process.on('SIGINT', () => void shutdown('SIGINT'));

// Start
const PORT = config.app.port;
app.listen(PORT, () => {
  logger.info(`ğŸš€ PSYGStore Backend started on port ${PORT}`);
  logger.info(`ğŸ“Š Environment: ${config.app.env}`);
  logger.info(`ğŸ—„ï¸  Database: Connected to MySQL`);
  logger.info(`ğŸ“š API Documentation: ${config.app.baseUrl}/api-docs`);

  // Price services (Ø¯Ø± dev Ù‡Ù… ÙØ¹Ø§Ù„Ù‡Ø› Ø§Ú¯Ø± Ø®ÙˆØ§Ø³ØªÛŒ Ø®Ø§Ù…ÙˆØ´ Ø¨Ø´Ù‡ Ø¨Ú¯Ùˆ ØªØ§ Ø´Ø±Ø·Ø´ Ø±Ùˆ Ø¨Ø°Ø§Ø±ÛŒÙ…)
  priceUpdateService.start();
  logger.info(`ğŸ’° Price update service started`);

  priceCronService.start();
  logger.info(`â° Price cron service started (every 5 minutes)`);
});

export default app;
